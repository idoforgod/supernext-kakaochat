## SuperChat 서비스 기능 단위 유저플로우 (최종본)

본 문서는 SuperChat 서비스의 핵심 기능에 대한 사용자 플로우를 정의합니다. 각 플로우는 `입력(Input)`, `처리(Processing)`, `출력(Output)` 단계로 구성되며, 발생 가능한 엣지케이스를 포함합니다.

### **1. 사용자 회원가입 (User Signup)**

**1. 입력 (Input)**
*   사용자가 회원가입 페이지에서 `닉네임`, `이메일 주소`, `비밀번호`, `비밀번호 확인`을 각 필드에 입력합니다.
*   사용자가 '회원가입' 버튼을 클릭합니다.

**2. 처리 (Processing)**
1.  시스템은 사용자가 입력한 4가지 정보와 함께 회원가입 요청을 수신합니다.
2.  **[데이터 유효성 검증]**
    *   모든 필드가 채워졌는지, 이메일 형식이 올바른지, 비밀번호가 최소 8자 이상인지, 비밀번호와 비밀번호 확인 값이 일치하는지 확인합니다.
    *   **[Edge Case]** 하나라도 유효성 검증에 실패하면, 처리를 중단하고 실패 원인과 함께 오류를 반환합니다.
3.  **[데이터 중복 검증]**
    *   입력된 `닉네임`과 `이메일 주소`가 데이터베이스에 이미 존재하는지 확인합니다.
    *   **[Edge Case]** 닉네임 또는 이메일이 이미 존재하면, 처리를 중단하고 해당 필드가 중복됨을 나타내는 오류를 반환합니다.
4.  **[사용자 생성]**
    *   모든 검증을 통과하면, 비밀번호를 해시(Hash) 처리하여 사용자 정보를 `비활성(inactive)` 상태로 데이터베이스에 저장합니다.
5.  **[인증 절차]**
    *   고유한 이메일 인증 토큰을 생성하여 사용자 이메일 주소로 인증 링크를 발송합니다.
    *   **[Edge Case]** 이메일 발송 시스템 오류 시, 해당 오류를 로그에 기록합니다.

**3. 출력 (Output)**
*   **[성공 시]** 사용자에게 이메일 확인이 필요하다는 피드백을 UI에 표시하고, 로그인 페이지로 리디렉션합니다.
*   **[실패 시]** 유효성 또는 중복 오류에 대한 구체적인 피드백을 UI에 표시하며, 사용자는 회원가입 페이지에 머무릅니다.

---

### **2. 사용자 로그인 (User Login)**

**1. 입력 (Input)**
*   사용자가 로그인 페이지에서 `이메일 주소`와 `비밀번호`를 입력합니다.
*   사용자가 '로그인' 버튼을 클릭합니다.

**2. 처리 (Processing)**
1.  시스템은 로그인 요청을 수신하고, 입력 필드가 비어있는지 확인합니다.
2.  **[사용자 조회]** 입력된 `이메일 주소`로 사용자를 조회합니다.
    *   **[Edge Case]** 사용자가 없으면, 인증 실패 오류를 반환합니다.
3.  **[계정 상태 확인]** 조회된 계정이 `활성(active)` 상태인지 확인합니다.
    *   **[Edge Case]** 계정이 `비활성` 상태이면, 계정 활성화가 필요하다는 오류를 반환합니다.
4.  **[비밀번호 검증]** 입력된 비밀번호의 해시값과 데이터베이스의 해시값을 비교합니다.
    *   **[Edge Case]** 비밀번호가 일치하지 않으면, 인증 실패 오류를 반환합니다.
5.  **[세션 생성]** 인증 성공 시, 사용자 세션을 생성하고 토큰을 발급합니다.

**3. 출력 (Output)**
*   **[성공 시]** 세션 토큰을 브라우저에 저장하고, 사용자를 '채팅방 목록' 페이지로 리디렉션하며, 헤더를 로그인 상태로 변경합니다.
*   **[실패 시 - 인증 실패]** "이메일 또는 비밀번호가 잘못되었습니다"와 같은 일반적인 실패 피드백을 UI에 표시합니다.
*   **[실패 시 - 계정 비활성]** 계정 활성화가 필요하다는 구체적인 피드백을 UI에 표시합니다.

---

### **3. 새로운 채팅방 생성 (Create a New Chat Room)**

**1. 입력 (Input)**
*   사용자(로그인 상태)가 '채팅방 목록' 페이지에서 '채팅방 추가하기' 버튼을 클릭합니다.
*   이동된 페이지에서 `채팅방 이름`을 입력하고 '추가' 버튼을 클릭합니다.

**2. 처리 (Processing)**
1.  시스템은 채팅방 생성 요청을 수신하고, 사용자의 로그인 세션을 확인합니다.
2.  **[데이터 유효성 검증]** `채팅방 이름`이 비어있지 않고 최대 길이(100자)를 준수했는지 확인합니다.
    *   **[Edge Case]** 유효성 검증 실패 시, 오류를 반환합니다.
3.  **[채팅방 중복 검증]** 동일한 이름의 채팅방이 이미 존재하는지 확인합니다.
    *   **[Edge Case]** 이름이 중복되면, 중복 오류를 반환합니다.
4.  **[채팅방 생성]** 검증 통과 시, 새로운 채팅방 정보를 데이터베이스에 저장합니다.

**3. 출력 (Output)**
*   **[성공 시]** 사용자를 '채팅방 목록' 페이지로 리디렉션하며, 목록에 새로 생성된 채팅방이 표시됩니다.
*   **[실패 시]** 유효성 또는 중복 오류에 대한 피드백을 UI에 표시하며, 사용자는 생성 페이지에 머무릅니다.

---

### **4. 기존 채팅방 입장 (Enter a Chat Room)**

**1. 입력 (Input)**
*   사용자(로그인 상태)가 '채팅방 목록' 페이지에서 특정 채팅방 카드를 클릭합니다.

**2. 처리 (Processing)**
1.  시스템은 채팅방 입장 요청과 `roomId`를 수신하고, 사용자의 로그인 세션을 확인합니다.
2.  **[채팅방 유효성 검증]** `roomId`에 해당하는 채팅방이 DB에 존재하는지 확인합니다.
    *   **[Edge Case]** 채팅방이 존재하지 않으면 '찾을 수 없음' 오류를 반환합니다.
3.  **[데이터 로딩]** 채팅방 정보와 이전 메시지 내역을 데이터베이스에서 불러옵니다.
4.  **[실시간 연결 준비]** 해당 채팅방의 실시간 채널에 사용자를 참여시킬 준비를 합니다.

**3. 출력 (Output)**
*   **[성공 시]** 사용자를 해당 '채팅방 페이지'로 리디렉션하고, 채팅 내역을 표시하며, 실시간 메시지를 수신할 수 있는 상태로 만듭니다.
*   **[실패 시]** '채팅방을 찾을 수 없다'는 피드백과 함께 사용자를 '채팅방 목록' 페이지로 돌려보냅니다.

---

### **5. 메시지 전송 (Send a Message)**

**1. 입력 (Input)**
*   사용자가 채팅방의 메시지 입력 필드에 `텍스트 또는 이모지`를 입력합니다.
*   사용자가 '전송' 버튼을 클릭하거나 `Enter` 키를 누릅니다.

**2. 처리 (Processing)**
1.  클라이언트는 `메시지 내용`, `채팅방 ID` 등을 WebSocket 서버로 전송합니다.
2.  **[서버 수신 및 검증]** 서버는 사용자의 권한과 메시지 내용의 유효성을 검증합니다.
    *   **[Edge Case]** 메시지 내용이 비어있으면 처리를 중단합니다.
3.  **[메시지 저장]** 검증된 메시지를 타임스탬프와 함께 데이터베이스에 저장합니다.
    *   **[Edge Case]** DB 저장 실패 시, 보낸 사용자에게만 실패 피드백을 전송합니다.
4.  **[메시지 전파]** 해당 채팅방의 모든 클라이언트에게 새로운 메시지 데이터를 전송(Broadcast)합니다.

**3. 출력 (Output)**
*   **[성공 시]** 채팅방의 모든 사용자 UI에 새 메시지가 즉시 표시됩니다. 보낸 사용자의 입력 필드는 비워집니다. '채팅방 목록'의 최근 활동이 갱신됩니다.
*   **[실패 시]** 보낸 사용자에게 '전송 실패' 또는 '연결 끊김' 등의 피드백을 UI에 표시합니다.

---

### **6. 메시지에 답장하기 (Reply to a Message)**

**1. 입력 (Input)**
*   사용자가 특정 메시지의 '답장' 옵션을 선택합니다.
*   입력 필드에 답장할 `메시지 내용`을 입력하고 전송합니다.

**2. 처리 (Processing)**
1.  클라이언트는 `메시지 내용`, `채팅방 ID`, 그리고 **`원본 메시지 ID`**를 WebSocket 서버로 전송합니다.
2.  **[서버 수신 및 검증]** 기본 메시지 검증과 더불어 `원본 메시지 ID`가 유효한지 확인합니다.
    *   **[Edge Case]** 원본 메시지를 찾을 수 없으면, 답장 실패 오류를 반환합니다.
3.  **[메시지 저장]** 답장 메시지를 `원본 메시지 ID`를 참조하여 데이터베이스에 저장합니다.
4.  **[메시지 전파]** 해당 채팅방의 모든 클라이언트에게 답장 메시지와 원본 메시지 정보를 함께 전송합니다.

**3. 출력 (Output)**
*   **[성공 시]** 모든 사용자 UI에 원본 메시지와 시각적으로 연결된 형태의 새 답장 메시지가 표시됩니다.
*   **[실패 시]** 보낸 사용자에게 '답장하려는 원본 메시지를 찾을 수 없다'는 피드백을 UI에 표시합니다.

---

### **7. 메시지에 반응하기 (React to a Message)**

**1. 입력 (Input)**
*   사용자가 특정 메시지의 '좋아요(❤️)' 아이콘을 클릭합니다. (토글 방식)

**2. 처리 (Processing)**
1.  클라이언트는 `메시지 ID`, `반응 타입`, `사용자 정보` 등을 서버로 전송합니다.
2.  **[서버 수신 및 검증]** 서버는 사용자의 권한과 `메시지 ID`의 유효성을 확인합니다.
3.  **[반응 정보 처리]** 해당 사용자의 반응이 이미 있는지 확인하여 DB에 반응 정보를 추가하거나 삭제합니다.
    *   **[Edge Case]** DB 처리 실패 시, 롤백하고 오류를 반환합니다.
4.  **[변경사항 전파]** 해당 채팅방의 모든 클라이언트에게 `메시지 ID`와 갱신된 총 반응 개수를 전송합니다.

**3. 출력 (Output)**
*   **[성공 시]** 모든 사용자 UI에서 해당 메시지의 반응 아이콘 상태(활성/비활성)와 총 반응 개수가 실시간으로 갱신됩니다.
*   **[실패 시]** 요청한 사용자에게 일시적인 오류 피드백을 표시할 수 있습니다.

---

### **8. 닉네임 변경 (Change Nickname)**

**1. 입력 (Input)**
*   사용자가 '마이페이지'로 이동합니다.
*   `새 닉네임` 입력 필드에 변경할 닉네임을 입력하고 '저장' 버튼을 클릭합니다.

**2. 처리 (Processing)**
1.  시스템은 닉네임 변경 요청을 수신하고 사용자의 로그인 세션을 확인합니다.
2.  **[데이터 유효성 검증]** `새 닉네임`이 비어있지 않은지 확인합니다.
3.  **[닉네임 중복 검증]** `새 닉네임`이 다른 사용자에 의해 이미 사용되고 있는지 확인합니다.
    *   **[Edge Case]** 닉네임이 중복되면, 중복 오류를 반환합니다.
4.  **[데이터 업데이트]** 검증 통과 시, 데이터베이스에서 해당 사용자의 닉네임을 업데이트합니다.

**3. 출력 (Output)**
*   **[성공 시]** 사용자에게 변경 성공 피드백을 표시하고, 마이페이지 및 헤더 등 UI에 표시된 모든 닉네임이 즉시 갱신됩니다.
*   **[실패 시]** 유효성 또는 중복 오류에 대한 피드백을 UI에 표시하며, 사용자는 마이페이지에 머무릅니다.